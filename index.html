<!DOCTYPE html>
<html lang="en">
<head>
    <title>Image Convolution</title>
</head>
<body>
<h1>Image Convolution</h1>
<input type="file" id="input-image" />
<br />
<br />
<h2>Convolution Matrix</h2>
<table id="convolution-matrix">
    <tr>
        <td><input type="number" id="matrix-0-0" /></td>
        <td><input type="number" id="matrix-0-1" /></td>
        <td><input type="number" id="matrix-0-2" /></td>
    </tr>
    <tr>
        <td><input type="number" id="matrix-1-0" /></td>
        <td><input type="number" id="matrix-1-1" /></td>
        <td><input type="number" id="matrix-1-2" /></td>
    </tr>
    <tr>
        <td><input type="number" id="matrix-2-0" /></td>
        <td><input type="number" id="matrix-2-1" /></td>
        <td><input type="number" id="matrix-2-2" /></td>
    </tr>
</table>
<br />
<label for="iterations">Number of Iterations:</label>
<input type="number" id="iterations" value="1" />
<br />
<br />
<button id="convolve-button">Convolve</button>
<br />
<br />
<canvas id="output-canvas"></canvas>
<script>
    const inputImage = document.getElementById("input-image");
    const convolutionMatrix = [
        [
            document.getElementById("matrix-0-0"),
            document.getElementById("matrix-0-1"),
            document.getElementById("matrix-0-2")
        ],
        [
            document.getElementById("matrix-1-0"),
            document.getElementById("matrix-1-1"),
            document.getElementById("matrix-1-2")
        ],
        [
            document.getElementById("matrix-2-0"),
            document.getElementById("matrix-2-1"),
            document.getElementById("matrix-2-2")
        ]
    ];
    const iterationsInput = document.getElementById("iterations");
    const convolveButton = document.getElementById("convolve-button");
    const outputCanvas = document.getElementById("output-canvas");
    let inputImageData;

    function convertToGrayscale(imageData) {
        let grayscaleMatrix = [];
        for (let i = 0; i < imageData.height; i++) {
            grayscaleMatrix[i] = [];
            for (let j = 0; j < imageData.width; j++) {
                let index = (i * 4) * imageData.width + (j * 4);
                let r = imageData.data[index];
                let g = imageData.data[index + 1];
                let b = imageData.data[index + 2];
                grayscaleMatrix[i][j] = 0.3 * r + 0.59 * g + 0.11 * b;
            }
        }
        return grayscaleMatrix;
    }
    function convolution2D(largeMatrix, smallMatrix) {
        let result = [];
        for (let i = 0; i < largeMatrix.length - 2; i++) {
            result[i] = [];
            for (let j = 0; j < largeMatrix[i].length - 2; j++) {
                let sum = 0;
                for (let k = 0; k < 3; k++) {
                    for (let l = 0; l < 3; l++) {
                        sum += largeMatrix[i + k][j + l] * smallMatrix[k][l];
                    }
                }
                result[i][j] = sum;
            }
        }
        return result;
    }


    inputImage.addEventListener("change",
    function(event) {
        let reader = new FileReader();
        reader.onload = function(event) {
            let image = new Image();
            image.onload = function() {
                outputCanvas.width = image.width;
                outputCanvas.height = image.height;
                let context = outputCanvas.getContext("2d");
                context.drawImage(image, 0, 0 );
                inputImageData = context.getImageData(0, 0, image.width, image.height);
            };
            image.src = event.target.result;
        };
        reader.readAsDataURL(event.target.files[0]);
    });

    convolveButton.addEventListener("click",
    function() {
        if (!inputImageData) {
            return alert("Please select an image.");
        }
        let iterations = parseInt(iterationsInput.value);
        let finMatrix = convertToGrayscale(inputImageData);
        for (let i = 0; i < iterations; i++) {
            finMatrix = convolution2D(finMatrix, convolutionMatrix);
        }
        let canvas = document.getElementById('output-canvas');
        canvas.width = finMatrix[0].length;
        canvas.height = finMatrix.length;
        document.body.appendChild(canvas);

        let context = canvas.getContext('2d');

        let finImgData = context.createImageData(canvas.width, canvas.height);

        for (let j = 0; j < finMatrix.length; j++){
            for(let k = 0; k < finMatrix[0].length; k++){
                let ind = (j * canvas.width + j) * 4;
                finImgData.data[ind] = finMatrix[j][k];
                finImgData.data[ind+1] = finMatrix[j][k];
                finImgData.data[ind+2] = finMatrix[j][k];
                finImgData.data[ind+3] = 255;
            }
        }

        context.putImageData(finImgData,0,0);

    });
</script>
</body>
</html>
